let m=3;chrome.storage.onChanged.addListener(e=>{e.maxConcurrentRequests&&(m=e.maxConcurrentRequests.newValue||3,d())});chrome.storage.local.get("maxConcurrentRequests",e=>{e.maxConcurrentRequests&&(m=e.maxConcurrentRequests)});const u="data-soop-translated";let i=[],l=0;async function d(){for(;i.length>0&&l<m;){const e=i.shift();e&&(l++,e())}}function h(e){i.push(e),d()}function C(e){return new Promise((o,n)=>{const r={type:"TRANSLATE",text:e};chrome.runtime.sendMessage(r,t=>{if(chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t.success&&t.result?o(t.result):n(new Error(t.error??"Unknown error"))})})}function E(e,o){const n=e.parentElement?.querySelector(".soop-translation");n&&n.remove();const r=document.createElement("span");r.className="soop-translation",r.textContent=`üåê ${o}`,r.style.cssText=["display: block","font-size: 0.85em","color: #aaaadd","margin-top: 2px","word-break: break-word","user-select: text"].join(";"),e.insertAdjacentElement("afterend",r)}async function c(e){const o=e.parentElement;if(!o||o.getAttribute(u)==="true")return;o.setAttribute(u,"true");const n=e.cloneNode(!0),r=n.querySelector("#btn-translate");r&&r.remove();const t=n.textContent?.trim()||"";if(!(!t||t.length<2))return new Promise(a=>{h(async()=>{try{const s=await C(t);s&&s!==t&&E(e,s)}catch(s){console.warn("[SOOP Translator] Failed to translate:",s),o.removeAttribute(u)}finally{l--,d(),a()}})})}const b=".message-text[id] p#message-original";function f(e){return Array.from(e.querySelectorAll(b))}function g(){new MutationObserver(n=>{for(const r of n)for(const t of r.addedNodes){if(!(t instanceof Element))continue;if(t.matches("p#message-original")){c(t);continue}const a=t.querySelector("p#message-original");if(a){c(a);continue}for(const s of f(t))c(s)}}).observe(document.body,{childList:!0,subtree:!0});const o=f(document);for(const n of o)c(n);console.log("[SOOP Translator] Chat observer started.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();
