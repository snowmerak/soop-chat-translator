let l=3;chrome.storage.onChanged.addListener(e=>{e.maxConcurrentRequests&&(l=e.maxConcurrentRequests.newValue||3,m())});chrome.storage.local.get("maxConcurrentRequests",e=>{e.maxConcurrentRequests&&(l=e.maxConcurrentRequests)});const c="data-soop-translated";let i=[],u=0;async function m(){for(;i.length>0&&u<l;){const e=i.shift();e&&(u++,e())}}function h(e){i.push(e),m()}function E(e){return new Promise((o,r)=>{const t={type:"TRANSLATE",text:e};chrome.runtime.sendMessage(t,n=>{if(chrome.runtime.lastError){r(new Error(chrome.runtime.lastError.message));return}n.success&&n.result?o(n.result):r(new Error(n.error??"Unknown error"))})})}function b(e,o){const r=e.parentElement?.querySelector(".soop-translation");r&&r.remove();const t=document.createElement("span");t.className="soop-translation",t.textContent=`ðŸŒ ${o}`,t.style.cssText=["display: block","font-size: 0.85em","color: #aaaadd","margin-top: 2px","word-break: break-word","user-select: text"].join(";"),e.insertAdjacentElement("afterend",t)}async function a(e){const o=e.parentElement;if(!o||o.getAttribute(c)==="true")return;o.setAttribute(c,"true");const r=e.cloneNode(!0);r.querySelectorAll("button, [id='btn-translate']").forEach(n=>n.remove());let t=r.textContent?.trim()||"";if(t.endsWith("ë²ˆì—­")&&(t=t.replace(/ë²ˆì—­$/,"").trim()),!(!t||t.length<2))return new Promise(n=>{h(async()=>{try{const s=await E(t);s&&s!==t&&b(e,s)}catch(s){console.warn("[SOOP Translator] Failed to translate:",s),o.removeAttribute(c)}finally{u--,m(),n()}})})}const p=".message-text[id] p#message-original";function d(e){return Array.from(e.querySelectorAll(p))}function f(){new MutationObserver(r=>{for(const t of r)for(const n of t.addedNodes){if(!(n instanceof Element))continue;if(n.matches("p#message-original")){a(n);continue}const s=n.querySelector("p#message-original");if(s){a(s);continue}for(const g of d(n))a(g)}}).observe(document.body,{childList:!0,subtree:!0});const o=d(document);for(const r of o)a(r);console.log("[SOOP Translator] Chat observer started.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
