const a="data-soop-translated";let c=[],l=!1;async function d(){if(l||c.length===0)return;l=!0,c.shift()()}function T(e){c.push(e),d()}function p(e){return new Promise((r,t)=>{const n={type:"TRANSLATE",text:e};chrome.runtime.sendMessage(n,o=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}o.success&&o.result?r(o.result):t(new Error(o.error??"Unknown error"))})})}function y(e,r){const t=e.querySelector(".soop-translation");t&&t.remove();const n=document.createElement("span");n.className="soop-translation",n.textContent=` ðŸŒ ${r}`,n.style.cssText=`
    display: block;
    font-size: 0.85em;
    color: #aaaadd;
    margin-top: 2px;
    word-break: break-word;
  `,e.appendChild(n)}async function i(e){if(e.getAttribute(a)==="true")return;e.setAttribute(a,"true");const r=Array.from(e.childNodes).filter(t=>t.nodeType===Node.TEXT_NODE).map(t=>t.textContent?.trim()).filter(Boolean).join(" ");if(!(!r||r.length<2))return new Promise(t=>{T(async()=>{try{const n=await p(r);n&&n!==r&&y(e,n)}catch(n){console.warn("[SOOP Translator] Failed to translate:",n),e.removeAttribute(a)}finally{l=!1,d(),t()}})})}const m=[".chat_list li .chat_txt",".chatting-list .message",".chat-list-wrap li .chat-text"];function u(e){for(const r of m){const t=Array.from(e.querySelectorAll(r));if(t.length>0)return t}return[]}function f(){new MutationObserver(t=>{for(const n of t)for(const o of n.addedNodes){if(!(o instanceof Element))continue;if(m.some(s=>o.matches(s))){i(o);continue}const h=u(o);for(const s of h)i(s)}}).observe(document.body,{childList:!0,subtree:!0});const r=u(document);for(const t of r)i(t);console.log("[SOOP Translator] Chat observer started.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
