let i=3;chrome.storage.onChanged.addListener(e=>{e.maxConcurrentRequests&&(i=e.maxConcurrentRequests.newValue||3,l())});chrome.storage.local.get("maxConcurrentRequests",e=>{e.maxConcurrentRequests&&(i=e.maxConcurrentRequests)});const a="data-soop-translated";let c=[],u=0;async function l(){for(;c.length>0&&u<i;){const e=c.shift();e&&(u++,e())}}function h(e){c.push(e),l()}function C(e){return new Promise((r,n)=>{const o={type:"TRANSLATE",text:e};chrome.runtime.sendMessage(o,t=>{if(chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t.success&&t.result?r(t.result):n(new Error(t.error??"Unknown error"))})})}function E(e,r){const n=e.parentElement?.querySelector(".soop-translation");n&&n.remove();const o=document.createElement("span");o.className="soop-translation",o.textContent=`üåê ${r}`,o.style.cssText=["display: block","font-size: 0.85em","color: #aaaadd","margin-top: 2px","word-break: break-word","user-select: text"].join(";"),e.insertAdjacentElement("afterend",o)}async function s(e){const r=e.parentElement;if(!r||r.getAttribute(a)==="true")return;r.setAttribute(a,"true");const n=e.textContent?.trim();if(!(!n||n.length<2))return new Promise(o=>{h(async()=>{try{const t=await C(n);t&&t!==n&&E(e,t)}catch(t){console.warn("[SOOP Translator] Failed to translate:",t),r.removeAttribute(a)}finally{u--,l(),o()}})})}const p=".message-text[id] p#message-original";function d(e){return Array.from(e.querySelectorAll(p))}function f(){new MutationObserver(n=>{for(const o of n)for(const t of o.addedNodes){if(!(t instanceof Element))continue;if(t.matches("p#message-original")){s(t);continue}const m=t.querySelector("p#message-original");if(m){s(m);continue}for(const g of d(t))s(g)}}).observe(document.body,{childList:!0,subtree:!0});const r=d(document);for(const n of r)s(n);console.log("[SOOP Translator] Chat observer started.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
