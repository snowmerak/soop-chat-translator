var g=Object.defineProperty;var d=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var u=(e,t,r)=>d(e,typeof t!="symbol"?t+"":t,r);import{D as m}from"../../chunks/defaults-BtCEwwT1.js";class p{constructor(t,r){u(this,"baseUrl");u(this,"model");this.baseUrl=t.replace(/\/$/,""),this.model=r}async translate(t,r){const n={model:this.model,messages:[{role:"user",content:`Translate this chat message to ${r}. Output only the translation, nothing else:
${t}`}],temperature:.3,top_p:.95,max_completion_tokens:128,stream:!1,ngl:999,enable_think:!1},s=await fetch(`${this.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok)throw new Error(`API ${s.status}: ${s.statusText}`);const o=(await s.json()).choices?.[0]?.message?.content?.trim();if(!o)throw new Error("Empty response from API");return o}}const w=500,a=new Map;function T(e){const t=a.get(e);return t!==void 0&&(a.delete(e),a.set(e,t)),t}function f(e,t){if(a.size>=w){const r=a.keys().next().value;r!==void 0&&a.delete(r)}a.set(e,t)}async function y(){return new Promise(e=>{chrome.storage.local.get(m,t=>{e(t)})})}function E(e){switch(e){case"Korean":return"ko";case"English":return"en";case"Japanese":return"ja";case"Chinese (Simplified)":return"zh";case"Spanish":return"es";case"French":return"fr";default:return""}}chrome.runtime.onMessage.addListener((e,t,r)=>e.type!=="TRANSLATE"?!1:((async()=>{try{const n=await y();if(!n.enabled){r({success:!1,error:"Translation is disabled"});return}const s=`${n.targetLang}::${e.text}`,l=T(s);if(l!==void 0){r({success:!0,result:l,cached:!0});return}const o=E(n.targetLang);if(o){const c=await new Promise(i=>{chrome.i18n.detectLanguage(e.text,i)});if(c&&c.isReliable&&c.languages.length>0){const i=c.languages[0].language;if(i===o||i.startsWith(o)){f(s,e.text),r({success:!0,result:e.text,cached:!1,skipped:!0});return}}}const h=await new p(n.apiBase,n.model).translate(e.text,n.targetLang);f(s,h),r({success:!0,result:h,cached:!1})}catch(n){const s=n instanceof Error?n.message:"Unknown error";console.error("[SOOP Translator] Error:",s),r({success:!1,error:s})}})(),!0));
