var p=Object.defineProperty;var g=(e,t,a)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var f=(e,t,a)=>g(e,typeof t!="symbol"?t+"":t,a);import{D as m}from"../../chunks/defaults-BGNKfFu1.js";class y{constructor(t,a,r){f(this,"baseUrl");f(this,"model");f(this,"apiKey");this.baseUrl=t.replace(/\/$/,""),this.model=a,this.apiKey=r}async translate(t,a){const r={model:this.model,messages:[{role:"user",content:`Translate this chat message to ${a}. You MUST output strictly in JSON format like this: {"translation": "..."}
Do not add any explanation or notes.
Message:
${t}`}],temperature:.1,top_p:.95,max_completion_tokens:128,stream:!1,ngl:999,enable_think:!1,enable_json:!0},n={"Content-Type":"application/json"};this.apiKey&&(n.Authorization=`Bearer ${this.apiKey}`);const o=await fetch(`${this.baseUrl}/v1/chat/completions`,{method:"POST",headers:n,body:JSON.stringify(r)});if(!o.ok)throw new Error(`API ${o.status}: ${o.statusText}`);let s=(await o.json()).choices?.[0]?.message?.content?.trim();if(!s)throw new Error("Empty response from API");try{s.startsWith("```json")?s=s.replace(/^\`\`\`json\s*/,"").replace(/\s*\`\`\`$/,""):s.startsWith("```")&&(s=s.replace(/^\`\`\`\s*/,"").replace(/\s*\`\`\`$/,""));const i=JSON.parse(s);if(i.translation)return i.translation}catch{console.warn("[SOOP Translator] Failed to parse JSON, falling back to raw output:",s)}return s}}const S=500,c=new Map;function w(e){const t=c.get(e);return t!==void 0&&(c.delete(e),c.set(e,t)),t}function d(e,t){if(c.size>=S){const a=c.keys().next().value;a!==void 0&&c.delete(a)}c.set(e,t)}async function T(){return new Promise(e=>{chrome.storage.local.get(m,t=>{e(t)})})}function $(e){switch(e){case"Korean":return"ko";case"English":return"en";case"Japanese":return"ja";case"Chinese (Simplified)":return"zh";case"Spanish":return"es";case"French":return"fr";default:return""}}chrome.runtime.onMessage.addListener((e,t,a)=>e.type!=="TRANSLATE"?!1:((async()=>{try{const r=await T();if(!r.enabled){a({success:!1,error:"Translation is disabled"});return}const n=`${r.targetLang}::${e.text}`,o=w(n);if(o!==void 0){a({success:!0,result:o,cached:!0});return}const l=$(r.targetLang);if(l){const u=await new Promise(h=>{chrome.i18n.detectLanguage(e.text,h)});if(u&&u.isReliable&&u.languages.length>0){const h=u.languages[0].language;if(h===l||h.startsWith(l)){d(n,e.text),a({success:!0,result:e.text,cached:!1,skipped:!0});return}}}const s=new y(r.apiBase,r.model,r.apiKey);console.log(`[SOOP Translator] Sending API request to: ${r.apiBase} | Model: ${r.model}`);const i=await s.translate(e.text,r.targetLang);d(n,i),a({success:!0,result:i,cached:!1})}catch(r){const n=r instanceof Error?r.message:"Unknown error";console.error("[SOOP Translator] Error:",n),a({success:!1,error:n})}})(),!0));
