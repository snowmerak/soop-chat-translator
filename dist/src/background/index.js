var g=Object.defineProperty;var p=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var h=(e,t,r)=>p(e,typeof t!="symbol"?t+"":t,r);import{D as m}from"../../chunks/defaults-BtCEwwT1.js";class w{constructor(t,r){h(this,"baseUrl");h(this,"model");this.baseUrl=t.replace(/\/$/,""),this.model=r}async translate(t,r){const s={model:this.model,messages:[{role:"user",content:`Translate this chat message to ${r}. You MUST output strictly in JSON format like this: {"translation": "..."}
Do not add any explanation or notes.
Message:
${t}`}],temperature:.1,top_p:.95,max_completion_tokens:128,stream:!1,ngl:999,enable_think:!1,enable_json:!0},n=await fetch(`${this.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!n.ok)throw new Error(`API ${n.status}: ${n.statusText}`);let a=(await n.json()).choices?.[0]?.message?.content?.trim();if(!a)throw new Error("Empty response from API");try{a.startsWith("```json")?a=a.replace(/^\`\`\`json\s*/,"").replace(/\s*\`\`\`$/,""):a.startsWith("```")&&(a=a.replace(/^\`\`\`\s*/,"").replace(/\s*\`\`\`$/,""));const c=JSON.parse(a);if(c.translation)return c.translation}catch{console.warn("[SOOP Translator] Failed to parse JSON, falling back to raw output:",a)}return a}}const S=500,o=new Map;function T(e){const t=o.get(e);return t!==void 0&&(o.delete(e),o.set(e,t)),t}function d(e,t){if(o.size>=S){const r=o.keys().next().value;r!==void 0&&o.delete(r)}o.set(e,t)}async function y(){return new Promise(e=>{chrome.storage.local.get(m,t=>{e(t)})})}function E(e){switch(e){case"Korean":return"ko";case"English":return"en";case"Japanese":return"ja";case"Chinese (Simplified)":return"zh";case"Spanish":return"es";case"French":return"fr";default:return""}}chrome.runtime.onMessage.addListener((e,t,r)=>e.type!=="TRANSLATE"?!1:((async()=>{try{const s=await y();if(!s.enabled){r({success:!1,error:"Translation is disabled"});return}const n=`${s.targetLang}::${e.text}`,u=T(n);if(u!==void 0){r({success:!0,result:u,cached:!0});return}const a=E(s.targetLang);if(a){const i=await new Promise(l=>{chrome.i18n.detectLanguage(e.text,l)});if(i&&i.isReliable&&i.languages.length>0){const l=i.languages[0].language;if(l===a||l.startsWith(a)){d(n,e.text),r({success:!0,result:e.text,cached:!1,skipped:!0});return}}}const f=await new w(s.apiBase,s.model).translate(e.text,s.targetLang);d(n,f),r({success:!0,result:f,cached:!1})}catch(s){const n=s instanceof Error?s.message:"Unknown error";console.error("[SOOP Translator] Error:",n),r({success:!1,error:n})}})(),!0));
